{
    "type": "Ext.app.Controller",
    "reference": {
        "name": "items",
        "type": "array"
    },
    "codeClass": null,
    "userConfig": {
        "designer|userClassName": "Devices"
    },
    "name": "MyController",
    "designerId": "6ce882fa-eb1d-4863-9c06-c76d93e27216",
    "cn": [
        {
            "type": "controlleraction",
            "reference": {
                "name": "listeners",
                "type": "array"
            },
            "codeClass": null,
            "userConfig": {
                "designer|controlQuery": "dataview#deviceDataview",
                "designer|targetType": "Ext.dataview.DataView",
                "fn": "onDataviewItemTap",
                "implHandler": [
                    "var mainView = this.getMainView();",
                    "var valuesStore = Ext.getStore('DeviceValuesStore');",
                    "valuesStore.filter('DeviceId', record.data.Id);",
                    "",
                    "valuesStore.load();",
                    "",
                    "var device = record.data;",
                    "",
                    "mainView.push({",
                    "    xtype: 'devicedetailstabpanel',",
                    "    title: device.Name + ' - ' + device.Location,",
                    "    data: device",
                    "});",
                    ""
                ],
                "name": "itemtap"
            },
            "name": "onDataviewItemTap",
            "designerId": "d0522694-13c8-42c5-9e78-da8fb488bf72"
        },
        {
            "type": "controllerref",
            "reference": {
                "name": "items",
                "type": "array"
            },
            "codeClass": null,
            "userConfig": {
                "ref": "mainView",
                "selector": "#mainView"
            },
            "name": "mainView",
            "designerId": "47c4e436-8611-4bff-97fd-b57fdd686044"
        },
        {
            "type": "controlleraction",
            "reference": {
                "name": "listeners",
                "type": "array"
            },
            "codeClass": null,
            "userConfig": {
                "designer|controlQuery": "button#devicesReloadBtn",
                "designer|targetType": "Ext.Button",
                "fn": "onReloadTap",
                "implHandler": [
                    "var deviceStore = Ext.getStore('DeviceStore');",
                    "deviceStore.load();"
                ],
                "name": "tap"
            },
            "name": "onReloadTap",
            "designerId": "eb3098de-7923-45d3-9165-8485b976891d"
        },
        {
            "type": "controlleraction",
            "reference": {
                "name": "listeners",
                "type": "array"
            },
            "codeClass": null,
            "userConfig": {
                "designer|controlQuery": "dataview#deviceDataview",
                "designer|targetType": "Ext.dataview.DataView",
                "fn": "onDataviewRefresh",
                "implHandler": [
                    "var locationNames = [];",
                    "",
                    "var deviceStore = Ext.getStore('DeviceStore');",
                    "",
                    "var existingFilters = [];",
                    "var segButton = dataview.down('#filterSegmentedButton');",
                    "segButton.getItems().each(function(item)",
                    "                          {",
                    "                              existingFilters.push(item.locationFilter);",
                    "                          });",
                    "",
                    "",
                    "//Create list without duplicates",
                    "",
                    "var allRecords = deviceStore.queryBy(function(){return true;});",
                    "allRecords.each(function(element) {",
                    "    if(locationNames.indexOf(element.data.Location) === -1)",
                    "        locationNames.push(element.data.Location);",
                    "});",
                    "",
                    "locationNames.sort();",
                    "",
                    "var buttons = [];",
                    "locationNames.forEach(function(value, index, array) {",
                    "",
                    "    if(existingFilters.indexOf(value) === -1)",
                    "        buttons.push({ text: value, locationFilter:value });",
                    "});",
                    "segButton.add(buttons);",
                    ""
                ],
                "name": "refresh"
            },
            "name": "onDataviewRefresh",
            "designerId": "62fd5231-f582-429a-96d3-afa1576d8abf"
        },
        {
            "type": "controlleraction",
            "reference": {
                "name": "listeners",
                "type": "array"
            },
            "codeClass": null,
            "userConfig": {
                "designer|controlQuery": "segmentedbutton#filterSegmentedButton",
                "designer|targetType": "Ext.SegmentedButton",
                "fn": "onSegmentedbuttonToggle",
                "implHandler": [
                    "if(!isPressed)",
                    "    return;",
                    "",
                    "var deviceStore = Ext.getStore('DeviceStore');",
                    "var filter = button.locationFilter;",
                    "if(filter)",
                    "{",
                    "    if(filter == 'all')",
                    "        deviceStore.clearFilter();",
                    "    else",
                    "        deviceStore.filter('Location', filter);",
                    "}"
                ],
                "name": "toggle"
            },
            "name": "onSegmentedbuttonToggle",
            "designerId": "cef6ff2e-9edb-4f2b-8b33-c218cdf788e1"
        },
        {
            "type": "controllerref",
            "reference": {
                "name": "items",
                "type": "array"
            },
            "codeClass": null,
            "userConfig": {
                "ref": "deviceDetailsTabPanel",
                "selector": "tabpanel#deviceDetailsTabPanel"
            },
            "name": "deviceDetailsTabPanel",
            "designerId": "680f921f-1379-447c-9eb4-b7d2e1e782c0"
        },
        {
            "type": "controllerref",
            "reference": {
                "name": "items",
                "type": "array"
            },
            "codeClass": null,
            "userConfig": {
                "ref": "filterSegmentedButton",
                "selector": "segmentedbutton#filterSegmentedButton"
            },
            "name": "filterSegmentedButton",
            "designerId": "54a5249d-9493-4bee-8fa3-8f3dbfd7f044"
        },
        {
            "type": "controllerref",
            "reference": {
                "name": "items",
                "type": "array"
            },
            "codeClass": null,
            "userConfig": {
                "ref": "deviceToolbar",
                "selector": "toolbar#deviceToolbar"
            },
            "name": "deviceToolbar",
            "designerId": "1cd3ee3c-d4f0-4358-8fe1-f188665be5af"
        },
        {
            "type": "controlleraction",
            "reference": {
                "name": "listeners",
                "type": "array"
            },
            "codeClass": null,
            "userConfig": {
                "designer|controlQuery": "panel#devicesPanel",
                "designer|targetType": "Ext.Panel",
                "fn": "onPanelInitialize",
                "implHandler": [
                    " var deviceStore = Ext.getStore('DeviceStore');",
                    "        deviceStore.load();"
                ],
                "name": "initialize"
            },
            "name": "onPanelInitialize",
            "designerId": "98b9126d-23de-4dac-b5f9-da592bdd0934"
        },
        {
            "type": "controlleraction",
            "reference": {
                "name": "listeners",
                "type": "array"
            },
            "codeClass": null,
            "userConfig": {
                "designer|controlQuery": "panel#deviceControlPanel",
                "designer|targetType": "Ext.Panel",
                "fn": "onControlPanelShow",
                "implHandler": [
                    "if(component.IsLoaded)",
                    "    return;",
                    "",
                    "component.IsLoaded = true;",
                    "",
                    "var device = component.getParent().getData();",
                    "",
                    "//Create Device Type Commands",
                    "var typeStore = Ext.getStore('DeviceTypeCommandStore');",
                    "typeStore.filter('DeviceTypeId', device.DeviceTypeId);",
                    "typeStore.load({",
                    "    callback: function(records, operation, success) {",
                    "        // the operation object contains all of the details of the load operation",
                    "",
                    "        typeStore.getData().each(function(item){",
                    "            var command = item.raw;",
                    "            zvsMobile.controller.Devices.createControl(command, null, 'DeviceTypeCommand', device, component);",
                    "        });",
                    "    }",
                    "});",
                    "",
                    "//Create Device Commands",
                    "Ext.Ajax.request({",
                    "    url: zvsMobile.app.getBaseUrl() + 'odata4/DeviceValues/?$filter=DeviceId eq '+device.Id+' and Genre eq \\'User\\'&$select=UniqueIdentifier, Value',",
                    "    method: 'GET',",
                    "    scope : this,",
                    "    headers: {",
                    "        'Content-Type': 'application/json',",
                    "        'X-zvsToken': zvsMobile.app.getToken()",
                    "    },",
                    "    success: function (response, opts) {",
                    "        var result = JSON.parse(response.responseText);",
                    "        if (result.value.length > 0) {",
                    "            var values = result.value;",
                    "",
                    "            var commandFilter = '';",
                    "",
                    "            for(i=0; i<values.length; i++) {",
                    "                var value = values[i];",
                    "",
                    "                if(i !== 0 )",
                    "                    commandFilter = commandFilter + ' or';",
                    "",
                    "                commandFilter = commandFilter + ' CustomData2 eq \\''+value.UniqueIdentifier+'\\'';",
                    "            }",
                    "",
                    "            var uri = 'odata4/DeviceCommands/?$filter=DeviceId eq ' + device.Id;",
                    "            uri = uri + ' and ' + commandFilter;",
                    "            uri = uri + '&$expand=Options';",
                    "",
                    "            var store = Ext.getStore('DeviceCommandStore');",
                    "            store.getProxy().setUrl(uri);",
                    "            store.load({",
                    "                callback: function(records, operation, success) {",
                    "                    // the operation object contains all of the details of the load operation",
                    "",
                    "                    store.getData().each(function(item){",
                    "",
                    "                        var defaultValue= null;",
                    "                        for(i=0; i<values.length; i++) {",
                    "                            if(values[i].UniqueIdentifier == item.data.CustomData2)",
                    "                                defaultValue =values[i].Value;",
                    "                        }",
                    "",
                    "                        var command = item.raw;",
                    "                        zvsMobile.controller.Devices.createControl(command, defaultValue, 'DeviceCommand', device, component);",
                    "",
                    "                    });",
                    "                },",
                    "                scope: this",
                    "            });",
                    "        }",
                    "        else {",
                    "            component.setError('Unabled to load device commands.');",
                    "        }",
                    "    },",
                    "    failure: function (response, opts) {",
                    "        var result = JSON.parse(response.responseText);",
                    "        component.setError(result.error.message);",
                    "    }",
                    "});",
                    ""
                ],
                "name": "show"
            },
            "name": "onControlPanelShow",
            "designerId": "b1f50205-1b5a-4c2c-812f-74a0118902c0"
        },
        {
            "type": "staticfunction",
            "reference": {
                "name": "items",
                "type": "array"
            },
            "codeClass": null,
            "userConfig": {
                "designer|params": [
                    "command, defaultValue, commandType, device, component"
                ],
                "fn": "createControl",
                "implHandler": [
                    "if(command.ArgumentType == 'LIST')",
                    "{",
                    "    var options = [];",
                    "    command.Options.forEach(function(option){",
                    "        options.push({text: option.Name,  value: option.Name});",
                    "    });",
                    "",
                    "    if(defaultValue === null)",
                    "    {",
                    "        defaultValue = '- select -';",
                    "        options.unshift( {text: '- select -',  value: '- select -'});",
                    "    }",
                    "",
                    "    var input = component.add({",
                    "        xtype: 'selectfield',",
                    "        label: command.Name,",
                    "        value:defaultValue,",
                    "        margin: '10 5 0 5 ',",
                    "        command: command,",
                    "        commandType: commandType,",
                    "        device: device,",
                    "        options: options",
                    "    });",
                    "",
                    "    input.suspendEvents();",
                    "    input.setValue(defaultValue);",
                    "    input.resumeEvents(true);",
                    "",
                    "}",
                    "else if(command.ArgumentType == 'NONE')",
                    "{",
                    "    var input = component.add({",
                    "        xtype: 'checkboxfield',",
                    "        label: command.Name,",
                    "",
                    "        margin: '10 5 0 5 ',",
                    "        command: command,",
                    "        commandType: commandType,",
                    "        device: device",
                    "    });",
                    "}",
                    "else if(command.ArgumentType == 'STRING')",
                    "{",
                    "",
                    "    var input = component.add({",
                    "        xtype: 'textfield',",
                    "        label: command.Name,",
                    "        clearIcon:false,",
                    "        margin: '10 5 0 5 ',",
                    "        command: command,",
                    "        commandType: commandType,",
                    "        device: device",
                    "    });",
                    "    if(defaultValue !== null)",
                    "    {",
                    "        input.suspendEvents();",
                    "        input.setValue(defaultValue);",
                    "        input.resumeEvents(true);",
                    "    }",
                    "",
                    "}",
                    "else if(command.ArgumentType == 'BOOL')",
                    "{",
                    "",
                    "    var input = component.add({",
                    "        xtype: 'togglefield',",
                    "        label: command.Name,",
                    "        margin: '10 5 0 5 ',",
                    "        command: command,",
                    "        commandType: commandType,",
                    "        device: device",
                    "    });",
                    "    if(defaultValue !== null)",
                    "    {",
                    "        input.suspendEvents();",
                    "        input.setValue(defaultValue);",
                    "        input.resumeEvents(true);",
                    "    }",
                    "",
                    "}",
                    "else if(command.ArgumentType == 'BYTE' || command.ArgumentType == 'INTEGER' || command.ArgumentType == 'DECIMAL' || command.ArgumentType == 'SHORT')",
                    "{",
                    "",
                    "    var input = component.add({",
                    "        xtype: 'numberfield',",
                    "        label: command.Name,",
                    "",
                    "        clearIcon:false,",
                    "        margin: '10 5 0 5 ',",
                    "        command: command,",
                    "        commandType: commandType,",
                    "        device: device",
                    "    });",
                    "    if(defaultValue !== null)",
                    "    {",
                    "        input.suspendEvents();",
                    "        input.setValue(defaultValue);",
                    "        input.resumeEvents(true);",
                    "    }",
                    "",
                    "}",
                    ""
                ]
            },
            "name": "createControl",
            "designerId": "5e1914fd-b077-4a28-ac06-28bc74a8016c"
        },
        {
            "type": "controlleraction",
            "reference": {
                "name": "listeners",
                "type": "array"
            },
            "codeClass": null,
            "userConfig": {
                "designer|controlQuery": "devicecontrolpanel selectfield",
                "designer|targetType": "Ext.field.Select",
                "fn": "onSelectfieldChange",
                "implHandler": [
                    "if(newValue === '- select -')",
                    "    return;",
                    "",
                    "var type = selectfield.commandType;",
                    "var id = selectfield.command.Id;",
                    "var device = selectfield.device;",
                    "",
                    "if(type === 'DeviceCommand' || type === 'DeviceTypeCommand')",
                    "{",
                    "    selectfield.disable();",
                    "    zvsMobile.app.executeCommand(id, newValue.toString(), device.Id.toString(), function(success, error){",
                    "        selectfield.enable();",
                    "        if(success)",
                    "        {",
                    "            selectfield.getParent().setSuccess(success);",
                    "",
                    "            var deviceStore = Ext.getStore('DeviceStore');",
                    "            deviceStore.needsRefresh = true;",
                    "        }",
                    "        else",
                    "            selectfield.getParent().setError(error);",
                    "    });",
                    "}",
                    "",
                    ""
                ],
                "name": "change"
            },
            "name": "onSelectfieldChange",
            "designerId": "05fd27a3-1115-494c-833c-0e6469ec4a14"
        },
        {
            "type": "controlleraction",
            "reference": {
                "name": "listeners",
                "type": "array"
            },
            "codeClass": null,
            "userConfig": {
                "designer|controlQuery": "devicecontrolpanel textfield",
                "designer|targetType": "Ext.field.Text",
                "fn": "onTextfieldChange",
                "implHandler": [
                    "if(textfield.command)",
                    "{",
                    "",
                    "    var type = textfield.commandType;",
                    "    var command = textfield.command;",
                    "    var id = textfield.command.Id;",
                    "    var device = textfield.device;",
                    "",
                    "    if(type === 'DeviceCommand' || type === 'DeviceTypeCommand')",
                    "    {",
                    "        if(command.ArgumentType == 'STRING')",
                    "        {",
                    "            textfield.disable();",
                    "            zvsMobile.app.executeCommand(id, newValue.toString(), device.Id.toString(), function(success, error){",
                    "                textfield.enable();",
                    "                if(success)",
                    "                    {",
                    "                    textfield.getParent().setSuccess(success);",
                    "                        ",
                    "                        var deviceStore = Ext.getStore('DeviceStore');",
                    "            deviceStore.needsRefresh = true;",
                    "                    }",
                    "                else",
                    "                    textfield.getParent().setError(error);",
                    "            });",
                    "        }",
                    "        else if(command.ArgumentType == 'BYTE' || command.ArgumentType == 'INTEGER' || command.ArgumentType == 'DECIMAL' || command.ArgumentType == 'SHORT')",
                    "        {",
                    "            var intRegex = /^\\d+$/;",
                    "            if(newValue === '' ||",
                    "               ((newValue < 0 || newValue >255) && command.ArgumentType == 'BYTE')",
                    "               //|| (item.data.ArgumentType == 'INTEGER' && intRegex.test(someNumber))",
                    "              )",
                    "            {",
                    "                Ext.Msg.alert('Aw, Snap!', 'Input not valid.');",
                    "                textfield.suspendEvents();",
                    "                textfield.setValue(oldValue);",
                    "                textfield.resumeEvents(true);",
                    "                return;",
                    "            }",
                    "",
                    "",
                    "            textfield.disable();",
                    "            zvsMobile.app.executeCommand(id, newValue.toString(), device.Id.toString(), function(success, error){",
                    "                textfield.enable();",
                    "                if(success)",
                    "                    {",
                    "                    textfield.getParent().setSuccess(success);",
                    "                        ",
                    "                        var deviceStore = Ext.getStore('DeviceStore');",
                    "            deviceStore.needsRefresh = true;",
                    "                    }",
                    "                else",
                    "                    textfield.getParent().setError(error);",
                    "            });",
                    "",
                    "        }",
                    "    }",
                    "}"
                ],
                "name": "change"
            },
            "name": "onTextfieldChange",
            "designerId": "2eb01caf-cdea-4728-beee-259d2a9dfda0"
        },
        {
            "type": "controlleraction",
            "reference": {
                "name": "listeners",
                "type": "array"
            },
            "codeClass": null,
            "userConfig": {
                "designer|controlQuery": "devicecontrolpanel togglefield",
                "designer|targetType": "Ext.field.Toggle",
                "fn": "onToggleFieldChange",
                "implHandler": [
                    "var type = togglefield.commandType;",
                    "var id = togglefield.command.Id;",
                    "var device = togglefield.device;",
                    "",
                    "if(type === 'DeviceCommand' || type === 'DeviceTypeCommand')",
                    "{",
                    "    togglefield.disable();",
                    "    zvsMobile.app.executeCommand(id, newValue> 0 ? 'true':'false', device.Id.toString(), function(success, error){",
                    "        togglefield.enable();",
                    "        if(success){",
                    "            togglefield.getParent().setSuccess(success);",
                    "            var deviceStore = Ext.getStore('DeviceStore');",
                    "            deviceStore.needsRefresh = true;",
                    "        }",
                    "        else",
                    "            togglefield.getParent().setError(error);",
                    "    });",
                    "}",
                    "",
                    ""
                ],
                "name": "change"
            },
            "name": "onToggleFieldChange",
            "designerId": "3a3c65a2-d920-4f38-ac50-ea14a1e4b3f2"
        },
        {
            "type": "controlleraction",
            "reference": {
                "name": "listeners",
                "type": "array"
            },
            "codeClass": null,
            "userConfig": {
                "designer|controlQuery": "devicecontrolpanel checkboxfield",
                "designer|targetType": "Ext.field.Checkbox",
                "fn": "checkboxfieldChange",
                "implHandler": [
                    "var type = checkboxfield.commandType;",
                    "var id = checkboxfield.command.Id;",
                    "var device = checkboxfield.device;",
                    "",
                    "if(type === 'DeviceCommand' || type === 'DeviceTypeCommand')",
                    "{",
                    "    //checkboxfield.disable();",
                    "    zvsMobile.app.executeCommand(id, newValue.toString(), device.Id.toString(), function(success, error){",
                    "        //checkboxfield.enable();",
                    "        if(success)",
                    "        {",
                    "            checkboxfield.getParent().setSuccess(success);",
                    "            var deviceStore = Ext.getStore('DeviceStore');",
                    "            deviceStore.needsRefresh = true;",
                    "        }",
                    "        else",
                    "            checkboxfield.getParent().setError(error);",
                    "    });",
                    "",
                    "",
                    "    checkboxfield.suspendEvents();",
                    "    setTimeout(function(){checkboxfield.uncheck();",
                    "                          checkboxfield.resumeEvents(true);}, 900);",
                    "",
                    "}"
                ],
                "name": "change"
            },
            "name": "checkboxfieldChange",
            "designerId": "b6f7cb11-d71c-4712-bf85-13c72e6466f6"
        },
        {
            "type": "controlleraction",
            "reference": {
                "name": "listeners",
                "type": "array"
            },
            "codeClass": null,
            "userConfig": {
                "designer|controlQuery": "panel#devicesPanel",
                "designer|targetType": "Ext.Panel",
                "fn": "onDevicePanelShow",
                "implHandler": [
                    "var deviceStore = Ext.getStore('DeviceStore');",
                    "if(deviceStore.needsRefresh)",
                    "{",
                    "    deviceStore.load();",
                    "    deviceStore.needsRefresh = false;",
                    "}"
                ],
                "name": "show"
            },
            "name": "onDevicePanelShow",
            "designerId": "f9ceef1c-3f69-4081-94ea-7c4debcb0bbc"
        }
    ]
}